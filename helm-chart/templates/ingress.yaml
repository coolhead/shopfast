{{- /*
Supported shapes:
  ingress: false
  ingress: true
  ingress: "alb"                # class name shorthand (enabled)
  ingress:
    enabled: true
    className: alb
    annotations: {...}
    hosts:
      - host: example.com
        paths:
          - path: /
            pathType: Prefix
    tls: true
*/ -}}

{{- $raw := .Values.ingress | default (dict) -}}
{{- $kind := kindOf $raw -}}

{{- $enabled := false -}}
{{- $className := "alb" -}}
{{- $ann := dict -}}
{{- $hosts := list -}}
{{- $tls := false -}}

{{- if eq $kind "bool" -}}
  {{- $enabled = $raw -}}
{{- else if eq $kind "map" -}}
  {{- if hasKey $raw "enabled" -}}
    {{- $enabled = index $raw "enabled" -}}
  {{- end -}}
  {{- if hasKey $raw "className" -}}
    {{- $className = index $raw "className" -}}
  {{- end -}}
  {{- if hasKey $raw "annotations" -}}
    {{- $ann = index $raw "annotations" -}}
  {{- end -}}
  {{- if hasKey $raw "hosts" -}}
    {{- $hosts = index $raw "hosts" -}}
  {{- end -}}
  {{- if hasKey $raw "tls" -}}
    {{- $tls = index $raw "tls" -}}
  {{- end -}}
{{- else if eq $kind "string" -}}
  {{- /* Treat string as className shorthand and enable */ -}}
  {{- $enabled = true -}}
  {{- $className = $raw -}}
{{- end -}}

{{- if $enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "shopfast.name" . }}
  namespace: {{ .Release.Namespace }}
  annotations:
    kubernetes.io/ingress.class: {{ $className | quote }}
    {{- with $ann }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  {{- if $tls }}
  tls:
    - hosts:
      {{- range $hosts }}
        - {{ .host | quote }}
      {{- end }}
      secretName: dummy  # ALB ignores; schema wants a name
  {{- end }}
  rules:
  {{- range $hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
        {{- range .paths }}
          - path: {{ .path | quote }}
            pathType: {{ .pathType | default "Prefix" }}
            backend:
              service:
                name: {{ include "shopfast.name" $ }}
                port:
                  name: http
        {{- end }}
  {{- end }}
{{- end }}
